function dz = zd(z)
%ZD

%Eric Westervelt
%01-May-2001 07:44:49

[n,m] = size(z);
if n == 1 | m == 1
  z1 = z(1); z2 = z(2);
else
  z1 = z(:,1); z2 = z(:,2);
end

[a,b,m] = controlParameters;

a0=a(1); a1=a(2); a2=a(3); a3=a(4); a4=a(5); a5=a(6); a6=a(7); 
b0=a(8); b1=a(9); b2=a(10); b3=a(11); b4=a(12); b5=a(13); b6=a(14); 
c0=a(15); c1=a(16); c2=a(17); c3=a(18); c4=a(19); c5=a(20); c6=a(21); 
d0=a(22); d1=a(23); d2=a(24); d3=a(25); d4=a(26); d5=a(27); d6=a(28); 

P1 = a0.*(1-(z1-b)./m).^6+6.*a1.*(z1-b)./m.*(1-(z1-b)./m).^5+15.*a2.* ...
     (z1-b).^2./m.^2.*(1-(z1-b)./m).^4+20.*a3.*(z1-b).^3./m.^3.*(1- ...
     (z1-b)./m).^3+15.*a4.*(z1-b).^4./m.^4.*(1-(z1-b)./m).^2+6.*a5.* ...
     (z1-b).^5./m.^5.*(1-(z1-b)./m)+a6.*(z1-b).^6./m.^6;

P2 = b0.*(1-(z1-b)./m).^6+6.*b1.*(z1-b)./m.*(1-(z1-b)./m).^5+15.*b2.* ...
     (z1-b).^2./m.^2.*(1-(z1-b)./m).^4+20.*b3.*(z1-b).^3./m.^3.*(1- ...
     (z1-b)./m).^3+15.*b4.*(z1-b).^4./m.^4.*(1-(z1-b)./m).^2+6.*b5.* ...
     (z1-b).^5./m.^5.*(1-(z1-b)./m)+b6.*(z1-b).^6./m.^6;

P3 = c0.*(1-(z1-b)./m).^6+6.*c1.*(z1-b)./m.*(1-(z1-b)./m).^5+15.*c2.* ...
     (z1-b).^2./m.^2.*(1-(z1-b)./m).^4+20.*c3.*(z1-b).^3./m.^3.*(1- ...
     (z1-b)./m).^3+15.*c4.*(z1-b).^4./m.^4.*(1-(z1-b)./m).^2+6.*c5.* ...
     (z1-b).^5./m.^5.*(1-(z1-b)./m)+c6.*(z1-b).^6./m.^6;

P4 = d0.*(1-(z1-b)./m).^6+6.*d1.*(z1-b)./m.*(1-(z1-b)./m).^5+15.*d2.* ...
     (z1-b).^2./m.^2.*(1-(z1-b)./m).^4+20.*d3.*(z1-b).^3./m.^3.*(1- ...
     (z1-b)./m).^3+15.*d4.*(z1-b).^4./m.^4.*(1-(z1-b)./m).^2+6.*d5.* ...
     (z1-b).^5./m.^5.*(1-(z1-b)./m)+d6.*(z1-b).^6./m.^6;

jac_P1 = -6.*a0.*(1-(z1-b)./m).^5./m+6.*a1./m.*(1-(z1-b)./m).^5-30.*a1.* ...
         (z1-b)./m.^2.*(1-(z1-b)./m).^4+30.*a2.*(z1-b)./m.^2.*(1-(z1- ...
         b)./m).^4-60.*a2.*(z1-b).^2./m.^3.*(1-(z1-b)./m).^3+60.*a3.*(z1- ...
         b).^2./m.^3.*(1-(z1-b)./m).^3-60.*a3.*(z1-b).^3./m.^4.*(1-(z1- ...
         b)./m).^2+60.*a4.*(z1-b).^3./m.^4.*(1-(z1-b)./m).^2-30.*a4.*(z1- ...
         b).^4./m.^5.*(1-(z1-b)./m)+30.*a5.*(z1-b).^4./m.^5.*(1-(z1- ...
         b)./m)-6.*a5.*(z1-b).^5./m.^6+6.*a6.*(z1-b).^5./m.^6;

jac_P2 = -6.*b0.*(1-(z1-b)./m).^5./m+6.*b1./m.*(1-(z1-b)./m).^5-30.*b1.* ...
         (z1-b)./m.^2.*(1-(z1-b)./m).^4+30.*b2.*(z1-b)./m.^2.*(1-(z1- ...
         b)./m).^4-60.*b2.*(z1-b).^2./m.^3.*(1-(z1-b)./m).^3+60.*b3.*(z1- ...
         b).^2./m.^3.*(1-(z1-b)./m).^3-60.*b3.*(z1-b).^3./m.^4.*(1-(z1- ...
         b)./m).^2+60.*b4.*(z1-b).^3./m.^4.*(1-(z1-b)./m).^2-30.*b4.*(z1- ...
         b).^4./m.^5.*(1-(z1-b)./m)+30.*b5.*(z1-b).^4./m.^5.*(1-(z1- ...
         b)./m)-6.*b5.*(z1-b).^5./m.^6+6.*b6.*(z1-b).^5./m.^6;

jac_P3 = -6.*c0.*(1-(z1-b)./m).^5./m+6.*c1./m.*(1-(z1-b)./m).^5-30.*c1.* ...
         (z1-b)./m.^2.*(1-(z1-b)./m).^4+30.*c2.*(z1-b)./m.^2.*(1-(z1- ...
         b)./m).^4-60.*c2.*(z1-b).^2./m.^3.*(1-(z1-b)./m).^3+60.*c3.*(z1- ...
         b).^2./m.^3.*(1-(z1-b)./m).^3-60.*c3.*(z1-b).^3./m.^4.*(1-(z1- ...
         b)./m).^2+60.*c4.*(z1-b).^3./m.^4.*(1-(z1-b)./m).^2-30.*c4.*(z1- ...
         b).^4./m.^5.*(1-(z1-b)./m)+30.*c5.*(z1-b).^4./m.^5.*(1-(z1- ...
         b)./m)-6.*c5.*(z1-b).^5./m.^6+6.*c6.*(z1-b).^5./m.^6;

jac_P4 = -6.*d0.*(1-(z1-b)./m).^5./m+6.*d1./m.*(1-(z1-b)./m).^5-30.*d1.* ...
         (z1-b)./m.^2.*(1-(z1-b)./m).^4+30.*d2.*(z1-b)./m.^2.*(1-(z1- ...
         b)./m).^4-60.*d2.*(z1-b).^2./m.^3.*(1-(z1-b)./m).^3+60.*d3.*(z1- ...
         b).^2./m.^3.*(1-(z1-b)./m).^3-60.*d3.*(z1-b).^3./m.^4.*(1-(z1- ...
         b)./m).^2+60.*d4.*(z1-b).^3./m.^4.*(1-(z1-b)./m).^2-30.*d4.*(z1- ...
         b).^4./m.^5.*(1-(z1-b)./m)+30.*d5.*(z1-b).^4./m.^5.*(1-(z1- ...
         b)./m)-6.*d5.*(z1-b).^5./m.^6+6.*d6.*(z1-b).^5./m.^6;

s(1) = -P1+1./2.*P3+z1;
s(2) = P1+1./2.*P3-z1;

% dz1
dz_1 = 500.*z2./(400.*jac_P3.*cos(s(2))+20.*jac_P3.*sin(s(2))-40.* ...
       jac_P1.*sin(s(2))-800.*jac_P1.*cos(s(2))+20.*jac_P3.*sin(s(1))- ...
       800.*jac_P1.*cos(s(1))+15.*jac_P3+50.*jac_P4-800.*cos(s(1))+40.* ...
       sin(s(1))-400.*jac_P3.*cos(s(1))+5444.*cos(P3)-956.*cos(-P2+P3)+ ...
       40.*jac_P1.*sin(s(1))+6142-956.*cos(P2)+478.*jac_P3.*cos(P2)- ...
       478.*jac_P2.*cos(P2)-800.*cos(s(2))-40.*sin(s(2))+1110.*jac_P1- ...
       478.*jac_P2.*cos(-P2+P3)+164.*cos(P4)-164.*cos(-P2-P4+P3)-164.* ...
       cos(P2+P4)+431.*jac_P2+82.*jac_P4.*cos(P4)+164.*jac_P2.*cos(P4)- ...
       82.*jac_P3.*cos(P4)-82.*jac_P4.*cos(-P2-P4+P3)-82.*jac_P4.* ...
       cos(P2+P4)+82.*jac_P3.*cos(P2+P4)-82.*jac_P2.*cos(P2+P4)-82.* ...
       jac_P2.*cos(-P2-P4+P3));

% dz2
dz_2 = 4697609773505525./35184372088832.*sin(1./2.*P3-z1)- ...
       1345255995021145./8796093022208.*sin(1./2.*P3+z1)+981./25.* ...
       sin(P1)-981./500.*cos(P1)-3299717078230185./140737488355328.* ...
       sin(-P2+1./2.*P3-z1)-40221./10000.*sin(-P2+1./2.*P3-z1-P4);

[n,m] = size(z);
if n == 1 | m == 1
  dz = [dz_1; dz_2];
else
  dz = [dz_1, dz_2];
end